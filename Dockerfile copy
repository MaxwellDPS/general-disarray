# Dockerfile for SIP AI Assistant
# ================================
# Multi-stage build for optimized image

# Stage 1: Build PJSIP
FROM nvidia/cuda:12.1.0-devel-ubuntu22.04 AS pjsip-builder

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    wget \
    pkg-config \
    python3 \
    python3-pip \
    python3-dev \
    libasound2-dev \
    libssl-dev \
    libopus-dev \
    libv4l-dev \
    libsdl2-dev \
    libavformat-dev \
    libavcodec-dev \
    libavdevice-dev \
    libavutil-dev \
    libswscale-dev \
    swig \
    && rm -rf /var/lib/apt/lists/*
  

# Build PJSIP
WORKDIR /tmp
RUN wget -q https://github.com/pjsip/pjproject/archive/refs/tags/2.14.tar.gz && \
    tar xzf 2.14.tar.gz && \
    cd pjproject-2.14 && \
    ./configure --enable-shared --with-opus && \
    make dep && \
    make -j$(nproc) && \
    make install

RUN pip install --upgrade setuptools wheel
# Build Python bindings
RUN cd /tmp/pjproject-2.14/pjsip-apps/src/swig && \
    make python && \
    cd python && \
    make wheel && \
    make install

# # Stage 2: Download Piper
# FROM ubuntu:22.04 AS piper-downloader

# RUN apt-get update && \
#     apt-get install -y wget

# WORKDIR /opt/piper

# # Detect architecture and download appropriate binary
# RUN ARCH=$(uname -m) && \
#     if [ "$ARCH" = "x86_64" ]; then PIPER_ARCH="amd64"; \
#     elif [ "$ARCH" = "aarch64" ]; then PIPER_ARCH="arm64"; \
#     else echo "Unsupported arch: $ARCH" && exit 1; fi && \
#     wget -q "https://github.com/rhasspy/piper/releases/download/v1.2.0/piper_${PIPER_ARCH}.tar.gz" && \
#     tar xzf "piper_${PIPER_ARCH}.tar.gz" && \
#     rm "piper_${PIPER_ARCH}.tar.gz"

# # Download voice model
# RUN mkdir -p models && cd models && \
#     wget -q "https://huggingface.co/rhasspy/piper-voices/resolve/main/en/en_US/amy/medium/en_US-amy-medium.onnx" && \
#     wget -q "https://huggingface.co/rhasspy/piper-voices/resolve/main/en/en_US/amy/medium/en_US-amy-medium.onnx.json"

# Stage 3: Final runtime image
# FROM nvidia/cuda:12.1.0-runtime-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    ffmpeg \
    libsndfile1 \
    portaudio19-dev \
    espeak-ng \
    libopus0 \
    libssl3 \
    libasound2 \
    sox \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy PJSIP from builder
# COPY --from=pjsip-builder /usr/local/lib/libpj*.so* /usr/local/lib/
# COPY --from=pjsip-builder /tmp/pjproject-2.14/pjsip-apps/src/swig/python/dist/*.whl /tmp/

# Update library cache
RUN ldconfig

# Create app directory
WORKDIR /app

# Install Python dependencies
COPY requirements.txt .
RUN pip3 install --no-cache-dir --upgrade pip wheel setuptools
RUN pip3 install --no-cache-dir torch torchvision torchaudio \
    --index-url https://download.pytorch.org/whl/cu121
RUN pip3 install --no-cache-dir faster-whisper
# RUN pip3 install --no-cache-dir /tmp/*.whl || true
RUN pip3 install --no-cache-dir -r requirements.txt 
    # rm -f /tmp/*.whl

# Copy application code
COPY src/ .

# Create data directories
RUN mkdir -p /app/data/recordings /app/data/logs

# Pre-download Whisper model (optional, can be large)
# RUN python3 -c "from faster_whisper import WhisperModel; WhisperModel('large-v3', device='cpu')"
# RUN python3 -c "from faster_whisper import WhisperModel; WhisperModel('medium', device='cpu')"

# Expose SIP ports
EXPOSE 5060/udp
EXPOSE 5060/tcp
EXPOSE 10000-10100/udp

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python3 -c "import socket; s=socket.socket(socket.AF_INET, socket.SOCK_DGRAM); s.bind(('', 5060)); s.close()" || exit 1

# Run the application
CMD ["python3", "main.py"]
